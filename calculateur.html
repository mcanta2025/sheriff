<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur d'infractions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="styles.css" rel="stylesheet" />

  <!-- Expose le client Supabase export√© par common.js (qui reste inchang√©) -->
  <script type="module">
    import { supabase } from "./common.js";
    window.supabase = supabase;
  </script>
</head>
<body>
  <header>
    <div class="brand">
      <img src="badge.png" alt="" />
      <div class="title">SAINT-GEORGES SHERIFF ‚Äî Calculateur</div>
    </div>
    <div class="pill">Outil calculateur</div>
  </header>

  <main class="container grid" style="grid-template-columns: 1.15fr .85fr; gap:16px">
    <!-- Colonne gauche : recherche + liste -->
    <section class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2>Recherche d'infractions</h2>
      </div>

      <div class="grid" style="grid-template-columns:1fr auto; align-items:center">
        <input id="search" type="text" placeholder="üîç Rechercher (infraction, cat√©gorie, classification)..." />
        <input id="calc-search" type="text" style="position:absolute; width:1px; height:1px; opacity:0; pointer-events:none" aria-hidden="true" />
      </div>

      <!-- Liste (tableau) -->
      <div id="infractions-list" style="margin-top:12px"></div>
    </section>

    <!-- Colonne droite : s√©lection + totaux -->
    <aside class="card table-card">
      <div class="spread" style="margin-bottom:10px">
        <h2>S√©lection en cours</h2>
        <button class="btn gold" id="btn-reset">Vider la s√©lection</button>
      </div>

      <!-- S√©lection (tableau) -->
      <div id="selection"></div>

      <div class="resume-grid" style="margin-top:12px">
        <div class="resume-box">
          <div class="resume-label">Total amendes</div>
          <div class="resume-value" id="total-amendes">$0</div>
        </div>
        <div class="resume-box">
          <div class="resume-label">Total fourri√®re</div>
          <div class="resume-value" id="total-fourriere">0 jour(s)</div>
        </div>
      </div>
    </aside>
  </main>

  <footer>¬© Sheriff‚Äôs Department ‚Ä¢ Saint-Georges</footer>

  <!-- Script applicatif (non-module) -->
  <script>
    (function(){
      const db = window.supabase;   // depuis common.js
      let infractions = [];
      let selection   = [];

      const el = {
        searchA: document.getElementById('search'),
        searchB: document.getElementById('calc-search'),
        list:    document.getElementById('infractions-list'),
        selWrap: document.getElementById('selection'),
        tAmende: document.getElementById('total-amendes'),
        tFour:   document.getElementById('total-fourriere'),
        reset:   document.getElementById('btn-reset')
      };

      // === helpers UI ===
      function money(n){ return `$${Number(n||0).toLocaleString()}`; }
      function badgeClassification(c){
        const up = String(c||'').toUpperCase();
        if (up === 'CONTRAVENTION') return '<span class="badge badge-green">Contravention</span>';
        if (up === 'DELIT')         return '<span class="badge badge-orange">D√©lit</span>';
        if (up === 'CRIME')         return '<span class="badge badge-red">Crime</span>';
        return `<span class="badge">${c||''}</span>`;
      }
      function categoryIcon(category = ""){
        const c = category.toLowerCase();
        if (c.includes('route') || c.includes('conduite')) return { ico:'üöó', label:category };
        if (c.includes('vol')   || c.includes('braquage'))  return { ico:'üß§', label:category };
        if (c.includes('agression') || c.includes('violence')) return { ico:'‚öîÔ∏è', label:category };
        if (c.includes('stup') || c.includes('drog'))       return { ico:'üíä', label:category };
        if (c.includes('arme'))                             return { ico:'üî´', label:category };
        if (c.includes('fraude') || c.includes('escro'))    return { ico:'üßæ', label:category };
        return { ico:'üìò', label: category || 'Autre' };
      }
      function catBadge(category){
        const {ico,label} = categoryIcon(category);
        // on r√©utilise ta classe .sel-pill pour un ‚Äúbadge‚Äù cat√©gorie
        return `<span class="sel-pill">${ico} ${label||''}</span>`;
      }

      // === recherche (deux inputs synchro au cas o√π) ===
      el.searchA.addEventListener('input', () => {
        if (el.searchB.value !== el.searchA.value) {
          el.searchB.value = el.searchA.value;
          el.searchB.dispatchEvent(new Event('input', { bubbles:true }));
        }
        filterAndRender();
      });
      el.searchB.addEventListener('input', () => {
        if (el.searchA.value !== el.searchB.value) {
          el.searchA.value = el.searchB.value;
          filterAndRender();
        }
      });

      el.reset.addEventListener('click', () => { selection = []; renderSelection(); });

      // === LISTE : tableau ===
      function renderList(arr){
        el.list.innerHTML = '';
        if (!arr?.length){
          el.list.innerHTML = '<div class="muted">Aucune infraction trouv√©e.</div>';
          return;
        }

        const table = document.createElement('table');
        table.className = 'table';
        table.setAttribute('aria-label','Liste des infractions');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Infraction</th>
              <th>Cat√©gorie</th>
              <th>Classification</th>
              <th style="text-align:right">Amende</th>
              <th style="text-align:right">Fourri√®re</th>
              <th style="text-align:right"></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        arr.forEach((it, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><b>${it.infraction}</b></td>
            <td>${catBadge(it.category)}</td>
            <td>${badgeClassification(it.classification)}</td>
            <td style="text-align:right">${money(it.amende)}</td>
            <td style="text-align:right">${Number(it.jour_fourriere||0)} j</td>
            <td style="text-align:right">
              <button class="btn add-btn" data-add="${idx}">Ajouter</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        table.querySelectorAll('button[data-add]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const idx = Number(e.currentTarget.getAttribute('data-add'));
            selection.push(arr[idx]);
            renderSelection();
          });
        });

        el.list.appendChild(table);
      }

      // === SELECTION : tableau ===
      function renderSelection(){
        el.selWrap.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'table';
        table.setAttribute('aria-label','S√©lection');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Infraction</th>
              <th>Cat√©gorie</th>
              <th style="text-align:right">Amende</th>
              <th style="text-align:right">Fourri√®re</th>
              <th style="text-align:right"></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        if (!selection.length){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" class="muted">Aucune s√©lection.</td>`;
          tbody.appendChild(tr);
        } else {
          selection.forEach((it, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><b>${it.infraction}</b></td>
              <td>${catBadge(it.category)}</td>
              <td style="text-align:right">${money(it.amende)}</td>
              <td style="text-align:right">${Number(it.jour_fourriere||0)} j</td>
              <td style="text-align:right">
                <button class="btn ghost" data-del="${idx}">Retirer</button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          table.querySelectorAll('button[data-del]').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const idx = Number(e.currentTarget.getAttribute('data-del'));
              selection.splice(idx, 1);
              renderSelection();
            });
          });
        }

        el.selWrap.appendChild(table);

        // Totaux (cartes existantes)
        const tA = selection.reduce((s,i)=> s + (Number(i.amende)||0), 0);
        const tF = selection.reduce((s,i)=> s + (Number(i.jour_fourriere)||0), 0);
        el.tAmende.textContent = money(tA);
        el.tFour.textContent   = `${tF} jour(s)`;
      }

      // === filtre ===
      function filterAndRender(){
        const q = (el.searchA.value||'').toLowerCase().trim();
        if (!q) return renderList(infractions);
        const out = infractions.filter(it =>
          String(it.infraction||'').toLowerCase().includes(q) ||
          String(it.category||'').toLowerCase().includes(q) ||
          String(it.classification||'').toLowerCase().includes(q)
        );
        renderList(out);
      }

      // === chargement ===
      async function load(){
        try{
          const { data, error } = await db.from('calculateur')
            .select('id, category, infraction, classification, amende, garde_a_vue, audition, jour_fourriere, peine_compl')
            .order('category', { ascending: true })
            .limit(2000);
          if (error) throw error;
          infractions = data || [];
        } catch(err){
          console.error('Erreur chargement calculateur:', err);
          el.list.innerHTML = `<div class="badge badge-red">Erreur : ${err.message}</div>`;
          return;
        }
        renderList(infractions);
        renderSelection();
      }

      load();
    })();
  </script>
</body>
</html>
