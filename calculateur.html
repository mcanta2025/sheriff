<section class="card">
  <h2>Liste des infractions</h2>
  <input id="search" type="text" placeholder="üîç Rechercher..." style="margin-bottom:10px;width:100%" />

  <table class="table" id="infractions-table">
    <thead>
      <tr>
        <th></th>
        <th>Cat√©gorie</th>
        <th>Infraction</th>
        <th>Classification</th>
        <th>Amende</th>
        <th>Fourri√®re (j)</th>
        <th>GAV</th>
        <th>Audition</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<aside class="card">
  <h2>S√©lection en cours</h2>
  <button class="btn gold" id="btn-reset">Vider la s√©lection</button>
  <div id="selection"></div>
  <div id="totaux"></div>
</aside>

<script>
const db = window.supabase;
let infractions = [];
let selection = [];

const tableBody = document.querySelector("#infractions-table tbody");
const searchInput = document.getElementById("search");

async function loadInfractions() {
  const { data, error } = await db.from("calculateur")
    .select("id, category, infraction, classification, amende, garde_a_vue, audition, jour_fourriere")
    .order("category");
  if (error) {
    console.error(error);
    return;
  }
  infractions = data;
  renderTable(infractions);
}

function renderTable(list) {
  tableBody.innerHTML = "";
  list.forEach(i => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${i.id}"></td>
      <td>${i.category}</td>
      <td>${i.infraction}</td>
      <td>${i.classification}</td>
      <td>$${Number(i.amende).toLocaleString()}</td>
      <td>${i.jour_fourriere}</td>
      <td>${i.garde_a_vue}</td>
      <td>${i.audition}</td>
    `;
    tr.querySelector("input").addEventListener("change", e => {
      if (e.target.checked) selection.push(i);
      else selection = selection.filter(x => x.id !== i.id);
      renderSelection();
    });
    tableBody.appendChild(tr);
  });
}

function renderSelection() {
  const box = document.getElementById("selection");
  const totaux = document.getElementById("totaux");
  box.innerHTML = selection.map(s => `<div>${s.infraction} - $${s.amende}</div>`).join("") || "<em>Aucune s√©lection</em>";

  const totalAmende = selection.reduce((sum,i)=>sum+i.amende,0);
  const totalFourr = selection.reduce((sum,i)=>sum+i.jour_fourriere,0);
  totaux.innerHTML = `<hr><b>Total :</b> $${totalAmende.toLocaleString()} ‚Äî ${totalFourr} j fourri√®re`;
}

searchInput.addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  renderTable(infractions.filter(i =>
    i.infraction.toLowerCase().includes(q) ||
    i.category.toLowerCase().includes(q) ||
    i.classification.toLowerCase().includes(q)
  ));
});

document.getElementById("btn-reset").addEventListener("click", ()=>{
  selection = [];
  renderSelection();
  document.querySelectorAll("#infractions-table input[type=checkbox]").forEach(c => c.checked = false);
});

loadInfractions();
</script>
