<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur d'infractions ‚Äî version avec cases √† cocher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="styles.css" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="common.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --line:#1f2937;
      --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444
    }
    body{margin:0;background:linear-gradient(180deg,#0b1025,#0f172a 25%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .container{max-width:1200px;margin:24px auto;padding:16px}
    .grid{display:grid;gap:16px}
    .spread{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .title{font-weight:800;font-size:18px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .btn{border:1px solid var(--line);background:#0b1224;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.gold{background:var(--warn);color:#2b1700;border-color:#a16207}
    .btn.ghost{background:transparent}
    input[type="text"], select{width:100%;background:#0b1224;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px}
    .pill { padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block }
    .pill.green { background:rgba(0,200,0,.15); color:#c6ffcf; border:1px solid rgba(0,200,0,.25)}
    .pill.orange{ background:rgba(255,165,0,.15); color:#ffd9a6; border:1px solid rgba(255,165,0,.25)}
    .pill.red   { background:rgba(200,0,0,.15); color:#ffb3b3; border:1px solid rgba(200,0,0,.25)}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    /* Liste */
    .list{max-height:520px;overflow:auto;margin-top:12px}
    .row-item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start;padding:10px;border-bottom:1px dashed var(--line)}
    .row-item:hover{background:rgba(255,255,255,.02)}

    /* S√©lection */
    table.sel{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.sel th, table.sel td{padding:10px 12px;background:#0b1224;border:1px solid var(--line)}
    table.sel th{background:#0a1122;font-weight:700}
  </style>
</head>
<body>
  <header class="spread container">
    <div class="brand spread" style="gap:10px"><img src="badge.png" alt="" style="height:32px"><div class="title">SAINT-GEORGES SHERIFF ‚Äî Calculateur</div></div>
    <div class="pill">Outil calculateur</div>
  </header>

  <main class="container grid" style="grid-template-columns:1.15fr .85fr">
    <!-- Colonne gauche : recherche + liste -->
    <section class="card">
      <div class="spread" style="margin-bottom:10px"><h2 style="margin:0">Recherche d'infractions</h2></div>

      <div class="grid" style="grid-template-columns:1fr auto;align-items:center;gap:10px">
        <input id="search" type="text" placeholder="üîç Rechercher (infraction, cat√©gorie, classification)..." />
        <div class="spread" style="gap:8px">
          <label class="small muted"><input type="checkbox" id="toggle-select-all" /> Tout cocher (visibles)</label>
        </div>
      </div>

      <div class="list" id="infractions-list"></div>
    </section>

    <!-- Colonne droite : s√©lection + totaux -->
    <aside class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2 style="margin:0">S√©lection en cours</h2>
        <button class="btn gold" id="btn-reset">Vider la s√©lection</button>
      </div>

      <div id="selection-wrapper">
        <table class="sel" id="selection-table" aria-label="S√©lection">
          <thead>
            <tr>
              <th>Infraction</th>
              <th>Cat√©gorie</th>
              <th>Amende</th>
              <th>Fourri√®re</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="selection-rows"><tr><td colspan="5" class="muted small">Aucune s√©lection.</td></tr></tbody>
        </table>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0" />

      <div id="totaux" class="grid" style="grid-template-columns:1fr 1fr;gap:12px"></div>
    </aside>
  </main>

  <footer class="container muted small">¬© Sheriff‚Äôs Department ‚Ä¢ Saint-Georges</footer>

  <script>
    // --- Pr√©-requis SUPABASE -------------------------------------------------
    // Dans common.js, assure-toi d'avoir quelque chose comme :
    //   const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    //   window.supabase = client;
    // Et que la table s'appelle bien "calculateur" avec les colonnes utilis√©es ci-dessous.

    (function(){
      const db = window.supabase; // d√©fini par common.js
      const el = {
        search: document.getElementById('search'),
        list: document.getElementById('infractions-list'),
        selBody: document.getElementById('selection-rows'),
        totaux: document.getElementById('totaux'),
        reset: document.getElementById('btn-reset'),
        selectAll: document.getElementById('toggle-select-all'),
      };

      /** Donn√©es **/
      let infractions = [];
      const selectedByKey = new Map(); // key -> item

      /** Helpers **/
      const keyOf = (it) => it.id ?? `${it.category}|${it.infraction}`;
      const safeNum = (v) => Number(v || 0) || 0;
      const fmtMoney = (n) => `$${safeNum(n).toLocaleString()}`;
      const classificationBadge = (c='') => {
        const x = String(c).toUpperCase();
        if (x === 'CONTRAVENTION') return '<span class="pill green">Contravention</span>';
        if (x === 'DELIT') return '<span class="pill orange">D√©lit</span>';
        if (x === 'CRIME') return '<span class="pill red">Crime</span>';
        return `<span class="pill">${c||''}</span>`;
      };

      /** Rendu : liste (avec checkbox) **/
      function renderList(arr){
        el.list.innerHTML = '';
        if (!arr?.length){
          el.list.innerHTML = '<div class="muted">Aucune infraction trouv√©e.</div>';
          return;
        }
        const frag = document.createDocumentFragment();
        arr.forEach((it) => {
          const k = keyOf(it);
          const row = document.createElement('div');
          row.className = 'row-item';
          row.innerHTML = `
            <div><input type="checkbox" class="pick" data-k="${k}"></div>
            <div>
              <div style="font-weight:700">${it.infraction}</div>
              <div class="small muted" style="margin:4px 0">${it.category||''}</div>
              ${classificationBadge(it.classification)}
            </div>
            <div class="small" style="text-align:right">
              <div><b>${fmtMoney(it.amende)}</b></div>
              <div class="muted">${safeNum(it.jour_fourriere)} jour(s) fourri√®re</div>
            </div>
          `;
          const cb = row.querySelector('input.pick');
          cb.checked = selectedByKey.has(k);
          cb.addEventListener('change', (e)=>{
            if (e.currentTarget.checked){
              selectedByKey.set(k, it);
            } else {
              selectedByKey.delete(k);
            }
            renderSelection();
          });
          frag.appendChild(row);
        });
        el.list.appendChild(frag);
      }

      /** Rendu : s√©lection + totaux **/
      function renderSelection(){
        const rows = [...selectedByKey.values()];
        if (!rows.length){
          el.selBody.innerHTML = '<tr><td colspan="5" class="muted small">Aucune s√©lection.</td></tr>';
        } else {
          el.selBody.innerHTML = rows.map((it)=>{
            const k = keyOf(it);
            return `
              <tr>
                <td>${it.infraction}</td>
                <td class="small muted">${it.category||''}</td>
                <td style="text-align:right">${fmtMoney(it.amende)}</td>
                <td style="text-align:right">${safeNum(it.jour_fourriere)} j</td>
                <td style="width:1%;text-align:right">
                  <button class="btn ghost small" data-k="${k}">Retirer</button>
                </td>
              </tr>
            `;
          }).join('');
          // Boutons retirer
          el.selBody.querySelectorAll('button[data-k]').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const k = e.currentTarget.getAttribute('data-k');
              selectedByKey.delete(k);
              // d√©cocher la case correspondante si visible
              const cb = el.list.querySelector(`input.pick[data-k="${CSS.escape(k)}"]`);
              if (cb) cb.checked = false;
              renderSelection();
            });
          });
        }
        const totalAmende = rows.reduce((s,i)=> s + safeNum(i.amende), 0);
        const totalFourr  = rows.reduce((s,i)=> s + safeNum(i.jour_fourriere), 0);
        el.totaux.innerHTML = `
          <div class="card">
            <div class="muted small">Total amendes</div>
            <div style="font-size:20px;font-weight:900">${fmtMoney(totalAmende)}</div>
          </div>
          <div class="card">
            <div class="muted small">Total fourri√®re</div>
            <div style="font-size:20px;font-weight:900">${totalFourr} jour(s)</div>
          </div>
        `;
      }

      /** Filtre **/
      function filterAndRender(){
        const q = (el.search.value||'').toLowerCase().trim();
        if (!q) return renderList(infractions);
        const out = infractions.filter(it =>
          String(it.infraction||'').toLowerCase().includes(q) ||
          String(it.category||'').toLowerCase().includes(q) ||
          String(it.classification||'').toLowerCase().includes(q)
        );
        renderList(out);
      }

      /** √âv√©nements **/
      el.search.addEventListener('input', filterAndRender);
      el.reset.addEventListener('click', ()=>{ selectedByKey.clear(); renderSelection(); renderList(infractions); });
      el.selectAll.addEventListener('change', ()=>{
        // coche/d√©coche tout ce qui est actuellement visible
        el.list.querySelectorAll('input.pick').forEach(cb=>{
          cb.checked = el.selectAll.checked;
          const k = cb.getAttribute('data-k');
          const it = infractions.find(x => keyOf(x) === k);
          if (!it) return;
          if (cb.checked) selectedByKey.set(k, it); else selectedByKey.delete(k);
        });
        renderSelection();
      });

      /** Chargement **/
      async function load(){
        try{
          if (!db?.from){ throw new Error('Supabase client introuvable. V√©rifie common.js.'); }
          const { data, error } = await db
            .from('calculateur')
            .select('id, category, infraction, classification, amende, garde_a_vue, audition, jour_fourriere, peine_compl')
            .order('category', { ascending: true })
            .limit(2000);
          if (error) throw error;
          infractions = data || [];
        } catch (e){
          console.error('Erreur chargement calculateur:', e);
          // Fallback pour tester l'UI en local sans BDD
          infractions = [
            { id:1, category:'Code de la route', infraction:'Exc√®s de vitesse', classification:'Contravention', amende:250, jour_fourriere:0 },
            { id:2, category:'Vol', infraction:'Vol simple', classification:'D√©lit', amende:1500, jour_fourriere:2 },
            { id:3, category:'Agressions', infraction:'Coups et blessures', classification:'Crime', amende:3500, jour_fourriere:5 }
          ];
        }
        renderList(infractions);
        renderSelection();
      }

      load();
    })();
  </script>
</body>
</html>
