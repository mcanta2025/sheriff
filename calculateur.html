<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur d'infractions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="styles.css" rel="stylesheet" />

  <!-- Ne PAS charger le CDN unpkg, on garde ton common.js -->
  <!-- <script src="https://unpkg.com/@supabase/supabase-js@2"></script> -->

  <!-- Expose supabase depuis common.js en global, en module -->
  <script type="module">
    import { supabase } from "./common.js";
    window.supabase = supabase;
  </script>

  <style>
    .pill { padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block }
    .pill.green { background:rgba(0,200,0,.15); color:#c6ffcf; border:1px solid rgba(0,200,0,.25)}
    .pill.orange{ background:rgba(255,165,0,.15); color:#ffd9a6; border:1px solid rgba(255,165,0,.25)}
    .pill.red   { background:rgba(200,0,0,.15); color:#ffb3b3; border:1px solid rgba(200,0,0,.25)}
    .inf-card { cursor:pointer; transition:transform .05s ease }
    .inf-card:hover { transform:translateY(-1px) }
    .selected-line { display:flex; justify-content:space-between; gap:10px; margin:6px 0 }
    .selected-line small { opacity:.8 }
    .right { text-align:right }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header class="spread container">
    <div class="brand">
      <img src="badge.png" alt="" style="height:32px">
      <div class="title">SAINT-GEORGES SHERIFF ‚Äî Calculateur</div>
    </div>
    <div class="pill">Outil calculateur</div>
  </header>

  <main class="container grid" style="grid-template-columns: 1.15fr .85fr; gap:20px">
    <section class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2>Recherche d'infractions</h2>
      </div>

      <div class="row" style="grid-template-columns:1fr auto">
        <input id="search" type="text" placeholder="üîç Rechercher (infraction, cat√©gorie, classification)..." />
        <input id="calc-search" type="text" style="position:absolute; width:1px; height:1px; opacity:0; pointer-events:none" aria-hidden="true" />
      </div>

      <div class="tiles" id="calc-list">
        <div id="infractions-list" class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:16px"></div>
      </div>
    </section>

    <aside class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2>S√©lection en cours</h2>
        <button class="btn gold" id="btn-reset">Vider la s√©lection</button>
      </div>

      <div id="calc-selection"><div id="selection"></div></div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0" />

      <div id="calc-totaux">
        <div id="totaux" class="grid" style="grid-template-columns:1fr 1fr"></div>
      </div>
    </aside>
  </main>

  <footer>¬© Sheriff‚Äôs Department ‚Ä¢ Saint-Georges</footer>

  <!-- Script applicatif -->
  <script>
    // Attendre que window.supabase soit pr√™t
    async function waitForSupabase(timeoutMs = 5000) {
      const start = Date.now();
      while (!window.supabase) {
        if (Date.now() - start > timeoutMs) {
          throw new Error("Supabase non charg√© (timeout). V√©rifie que tu ouvres via http:// et pas file://");
        }
        await new Promise(r => setTimeout(r, 50));
      }
      return window.supabase;
    }

    (async function(){
      try {
        const db = await waitForSupabase();

        let infractions = [];
        let selection = [];

        const el = {
          searchA: document.getElementById('search'),
          searchB: document.getElementById('calc-search'),
          list:    document.getElementById('infractions-list'),
          selWrap: document.getElementById('selection'),
          totaux:  document.getElementById('totaux'),
          reset:   document.getElementById('btn-reset')
        };

        el.searchA.addEventListener('input', () => {
          if (el.searchB.value !== el.searchA.value) {
            el.searchB.value = el.searchA.value;
            el.searchB.dispatchEvent(new Event('input', { bubbles:true }));
          }
          filterAndRender();
        });
        el.searchB.addEventListener('input', () => {
          if (el.searchA.value !== el.searchB.value) {
            el.searchA.value = el.searchB.value;
            filterAndRender();
          }
        });

        el.reset.addEventListener('click', () => { selection = []; renderSelection(); });

        function badge(classification) {
          const c = (classification || '').toUpperCase();
          if (c === 'CONTRAVENTION') return '<span class="pill green">Contravention</span>';
          if (c === 'DELIT')         return '<span class="pill orange">D√©lit</span>';
          if (c === 'CRIME')         return '<span class="pill red">Crime</span>';
          return `<span class="pill">${classification||''}</span>`;
        }

        function renderList(arr) {
          el.list.innerHTML = '';
          if (!arr || !arr.length) {
            el.list.innerHTML = '<div class="muted">Aucune infraction trouv√©e.</div>';
            return;
          }
          for (const it of arr) {
            const card = document.createElement('div');
            card.className = 'card inf-card';
            card.innerHTML = `
              <div class="spread" style="align-items:flex-start">
                <div style="max-width:78%">
                  <div style="font-weight:700; margin-bottom:4px">${it.infraction}</div>
                  <div class="muted small" style="margin-bottom:6px">${it.category}</div>
                  ${badge(it.classification)}
                </div>
                <div class="right">
                  <div><b>$${Number(it.amende||0).toLocaleString()}</b></div>
                  <small class="muted">${Number(it.jour_fourriere||0)} jour(s) fourri√®re</small>
                </div>
              </div>
            `;
            card.addEventListener('click', () => { selection.push(it); renderSelection(); });
            el.list.appendChild(card);
          }
        }

        function renderSelection() {
          el.selWrap.innerHTML = '';
          if (!selection.length) {
            el.selWrap.innerHTML = '<div class="muted small">Aucune s√©lection.</div>';
          } else {
            selection.forEach((it, idx) => {
              const line = document.createElement('div');
              line.className = 'selected-line';
              line.innerHTML = `
                <div>
                  <div><b>${it.infraction}</b></div>
                  <small class="muted">${it.category}</small>
                </div>
                <div class="right">
                  <div><b>$${Number(it.amende||0).toLocaleString()}</b></div>
                  <small class="muted">${Number(it.jour_fourriere||0)} j</small><br>
                  <button class="btn small ghost" data-idx="${idx}">Retirer</button>
                </div>
              `;
              line.querySelector('button').addEventListener('click', (e) => {
                const i = Number(e.currentTarget.dataset.idx);
                selection.splice(i,1);
                renderSelection();
              });
              el.selWrap.appendChild(line);
            });
          }

          const totalAmende = selection.reduce((s,i)=>s + (Number(i.amende)||0), 0);
          const totalFourr  = selection.reduce((s,i)=>s + (Number(i.jour_fourriere)||0), 0);

          el.totaux.innerHTML = `
            <div class="card">
              <div class="muted small">Total amendes</div>
              <div style="font-size:20px; font-weight:900">$${totalAmende.toLocaleString()}</div>
            </div>
            <div class="card">
              <div class="muted small">Total fourri√®re</div>
              <div style="font-size:20px; font-weight:900">${totalFourr} jour(s)</div>
            </div>
          `;
        }

        function filterAndRender() {
          const q = (el.searchA.value || '').toLowerCase().trim();
          if (!q) return renderList(infractions);
          const out = infractions.filter(it =>
            (it.infraction||'').toLowerCase().includes(q) ||
            (it.category||'').toLowerCase().includes(q) ||
            (it.classification||'').toLowerCase().includes(q)
          );
          renderList(out);
        }

        async function load() {
          try {
            const { data, error } = await db.from('calculateur')
              .select('id, category, infraction, classification, amende, garde_a_vue, audition, jour_fourriere, peine_compl')
              .order('category', { ascending: true })
              .limit(2000);
            if (error) throw error;
            infractions = data || [];
          } catch (err) {
            console.error('Erreur chargement calculateur:', err);
            document.getElementById('infractions-list').innerHTML =
              `<div class="pill red">Erreur de chargement : ${err.message}</div>`;
            return;
          }
          renderList(infractions);
          renderSelection();
        }

        load();
      } catch (e) {
        console.error(e);
        document.getElementById('infractions-list')?.insertAdjacentHTML(
          'beforebegin',
          `<div class="pill red" style="margin:12px 0">Init Supabase : ${e.message}</div>`
        );
      }
    })();
  </script>
</body>
</html>
