<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calculateur d'infractions</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="common.js"></script> <!-- ‚úÖ connexion et fonctions globales -->
  <style>
    .contravention { background: rgba(0, 200, 0, 0.1); }
    .delit { background: rgba(255, 165, 0, 0.15); }
    .crime { background: rgba(200, 0, 0, 0.15); }
    .selected { border: 2px solid gold; margin: 4px 0; padding: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Calculateur des Infractions</h1>
  </header>

  <main class="container grid grid-2">
    <!-- üîé Recherche -->
    <section class="card">
      <h2>Recherche d'infractions</h2>
      <input id="search" type="text" placeholder="üîç Rechercher une infraction..." />
      <div id="infractions-list"></div>
    </section>

    <!-- ‚úÖ S√©lection -->
    <section class="card">
      <h2>S√©lection en cours</h2>
      <div id="selection"></div>
      <div id="totaux"></div>
      <button class="btn gold" onclick="resetSelection()">Vider la s√©lection</button>
    </section>
  </main>

  <script>
    let infractions = [];
    let selection = [];

    // Charger les infractions depuis Supabase
    async function loadInfractions() {
      const { data, error } = await supabase.from("calculateur").select("*");
      if (error) {
        console.error("Erreur chargement infractions:", error);
        return;
      }
      infractions = data;
      renderInfractions(data);
    }

    // Affiche la liste
    function renderInfractions(list) {
      const container = document.getElementById("infractions-list");
      container.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = `${item.classification.toLowerCase()} card`;
        div.innerHTML = `
          <b>${item.infraction}</b><br>
          <small>Cat√©gorie: ${item.category}</small><br>
          <small>Amende: $${item.amende.toLocaleString()}</small><br>
          <small>Fourri√®re: ${item.jour_fourriere} jour(s)</small><br>
        `;
        div.onclick = () => addToSelection(item);
        container.appendChild(div);
      });
    }

    // Ajouter une infraction
    function addToSelection(item) {
      selection.push(item);
      renderSelection();
    }

    // Affiche la s√©lection
    function renderSelection() {
      const container = document.getElementById("selection");
      container.innerHTML = "";
      selection.forEach(item => {
        const div = document.createElement("div");
        div.className = `selected ${item.classification.toLowerCase()}`;
        div.innerHTML = `<b>${item.infraction}</b> - $${item.amende.toLocaleString()}`;
        container.appendChild(div);
      });

      const totalAmende = selection.reduce((sum, i) => sum + i.amende, 0);
      const totalFourriere = selection.reduce((sum, i) => sum + i.jour_fourriere, 0);

      document.getElementById("totaux").innerHTML = `
        <p><b>Total Amendes:</b> $${totalAmende.toLocaleString()}</p>
        <p><b>Total Fourri√®re:</b> ${totalFourriere} jours</p>
      `;
    }

    // Reset s√©lection
    function resetSelection() {
      selection = [];
      renderSelection();
    }

    // Filtrer en live
    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = infractions.filter(i =>
        i.infraction.toLowerCase().includes(term) ||
        i.category.toLowerCase().includes(term) ||
        i.classification.toLowerCase().includes(term)
      );
      renderInfractions(filtered);
    });

    // Charger au d√©marrage
    loadInfractions();
  </script>
</body>
</html>
