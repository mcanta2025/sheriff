<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur d'infractions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="styles.css" rel="stylesheet" />

  <!-- Expose le client Supabase export√© par common.js -->
  <script type="module">
    import { supabase } from "./common.js";
    window.supabase = supabase;
  </script>

  <!--
    ‚ö†Ô∏è Pas de styles agressifs ici.
    Ajoute ces classes dans ton CSS existant si tu veux les affiner :
      .table, .table-wrap, .td-right, .cat, .cat .ico
  -->
</head>
<body>
  <header class="spread container">
    <div class="brand">
      <img src="badge.png" alt="" style="height:32px" />
      <div class="title">SAINT-GEORGES SHERIFF ‚Äî Calculateur</div>
    </div>
    <div class="pill">Outil calculateur</div>
  </header>

  <main class="container grid" style="grid-template-columns: 1.15fr .85fr; gap:20px">
    <!-- Colonne gauche : recherche + liste -->
    <section class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2>Recherche d'infractions</h2>
      </div>

      <div class="row" style="grid-template-columns:1fr auto">
        <input id="search" type="text" placeholder="üîç Rechercher (infraction, cat√©gorie, classification)..." />
        <input id="calc-search" type="text" style="position:absolute; width:1px; height:1px; opacity:0; pointer-events:none" aria-hidden="true" />
      </div>

      <div id="infractions-list" class="table-wrap" style="margin-top:16px"></div>
    </section>

    <!-- Colonne droite : s√©lection + totaux -->
    <aside class="card">
      <div class="spread" style="margin-bottom:10px">
        <h2>S√©lection en cours</h2>
        <button class="btn gold" id="btn-reset">Vider la s√©lection</button>
      </div>

      <div id="selection" class="table-wrap"></div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0" />

      <div id="totaux" class="grid" style="grid-template-columns:1fr 1fr"></div>
    </aside>
  </main>

  <footer>¬© Sheriff‚Äôs Department ‚Ä¢ Saint-Georges</footer>

  <!-- Script applicatif (non-module) -->
  <script>
    (function(){
      const db = window.supabase;            // vient de common.js (expos√© plus haut)
      let infractions = [];
      let selection   = [];

      const el = {
        searchA: document.getElementById('search'),
        searchB: document.getElementById('calc-search'),
        list:    document.getElementById('infractions-list'),
        selWrap: document.getElementById('selection'),
        totaux:  document.getElementById('totaux'),
        reset:   document.getElementById('btn-reset')
      };

      // --- helpers ---
      function badge(classification) {
        const c = String(classification || '').toUpperCase();
        if (c === 'CONTRAVENTION') return '<span class="pill green">Contravention</span>';
        if (c === 'DELIT')         return '<span class="pill orange">D√©lit</span>';
        if (c === 'CRIME')         return '<span class="pill red">Crime</span>';
        return `<span class="pill">${classification || ''}</span>`;
      }

      function categoryIcon(category = "") {
        const c = category.toLowerCase();
        if (c.includes('route') || c.includes('conduite')) return { ico: 'üöó', label: category };
        if (c.includes('vol')   || c.includes('braquage'))  return { ico: 'üß§', label: category };
        if (c.includes('agression') || c.includes('violence')) return { ico: '‚öîÔ∏è', label: category };
        if (c.includes('stup') || c.includes('drog'))       return { ico: 'üíä', label: category };
        if (c.includes('arme'))                             return { ico: 'üî´', label: category };
        if (c.includes('fraude') || c.includes('escro'))    return { ico: 'üßæ', label: category };
        return { ico: 'üìò', label: category || 'Autre' };
      }
      function catBadge(category){
        const { ico, label } = categoryIcon(category);
        // classes neutres que tu pourras styler dans ton CSS
        return `<span class="cat"><span class="ico">${ico}</span><span>${label || ''}</span></span>`;
      }

      // --- √©couteurs de recherche ---
      el.searchA.addEventListener('input', () => {
        if (el.searchB.value !== el.searchA.value) {
          el.searchB.value = el.searchA.value;
          el.searchB.dispatchEvent(new Event('input', { bubbles:true }));
        }
        filterAndRender();
      });
      el.searchB.addEventListener('input', () => {
        if (el.searchA.value !== el.searchB.value) {
          el.searchA.value = el.searchB.value;
          filterAndRender();
        }
      });

      el.reset.addEventListener('click', () => { selection = []; renderSelection(); });

      // --- rendu : LISTE en tableau ---
      function renderList(arr) {
        const container = el.list;
        container.innerHTML = '';
        if (!arr || !arr.length) {
          container.innerHTML = '<div class="muted">Aucune infraction trouv√©e.</div>';
          return;
        }

        const table = document.createElement('table');
        table.className = 'table';
        table.setAttribute('aria-label', 'Liste des infractions');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Infraction</th>
              <th>Cat√©gorie</th>
              <th>Classification</th>
              <th class="td-right">Amende</th>
              <th class="td-right">Fourri√®re</th>
              <th class="td-right"></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        arr.forEach((it, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><b>${it.infraction}</b></td>
            <td>${catBadge(it.category)}</td>
            <td>${badge(it.classification)}</td>
            <td class="td-right">$${Number(it.amende||0).toLocaleString()}</td>
            <td class="td-right">${Number(it.jour_fourriere||0)} j</td>
            <td class="td-right">
              <button class="btn small" data-add="${idx}">Ajouter</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Ajout √† la s√©lection
        table.querySelectorAll('button[data-add]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const idx = Number(e.currentTarget.getAttribute('data-add'));
            selection.push(arr[idx]);
            renderSelection();
          });
        });

        container.appendChild(table);
      }

      // --- rendu : SELECTION en tableau ---
      function renderSelection() {
        const wrap = el.selWrap;
        wrap.innerHTML = '';

        const table = document.createElement('table');
        table.className = 'table';
        table.setAttribute('aria-label', 'S√©lection');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Infraction</th>
              <th>Cat√©gorie</th>
              <th class="td-right">Amende</th>
              <th class="td-right">Fourri√®re</th>
              <th class="td-right"></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        if (!selection.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" class="muted">Aucune s√©lection.</td>`;
          tbody.appendChild(tr);
        } else {
          selection.forEach((it, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><b>${it.infraction}</b></td>
              <td>${catBadge(it.category)}</td>
              <td class="td-right">$${Number(it.amende||0).toLocaleString()}</td>
              <td class="td-right">${Number(it.jour_fourriere||0)} j</td>
              <td class="td-right"><button class="btn small ghost" data-del="${idx}">Retirer</button></td>
            `;
            tbody.appendChild(tr);
          });

          // Retirer ligne
          table.querySelectorAll('button[data-del]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const idx = Number(e.currentTarget.getAttribute('data-del'));
              selection.splice(idx, 1);
              renderSelection();
            });
          });
        }

        wrap.appendChild(table);

        // Totaux
        const totalAmende = selection.reduce((s,i)=> s + (Number(i.amende)||0), 0);
        const totalFourr  = selection.reduce((s,i)=> s + (Number(i.jour_fourriere)||0), 0);
        el.totaux.innerHTML = `
          <div class="card">
            <div class="muted small">Total amendes</div>
            <div style="font-size:20px; font-weight:900">$${totalAmende.toLocaleString()}</div>
          </div>
          <div class="card">
            <div class="muted small">Total fourri√®re</div>
            <div style="font-size:20px; font-weight:900">${totalFourr} jour(s)</div>
          </div>
        `;
      }

      // --- filtrage ---
      function filterAndRender() {
        const q = (el.searchA.value || '').toLowerCase().trim();
        if (!q) return renderList(infractions);
        const out = infractions.filter(it =>
          String(it.infraction||'').toLowerCase().includes(q) ||
          String(it.category||'').toLowerCase().includes(q) ||
          String(it.classification||'').toLowerCase().includes(q)
        );
        renderList(out);
      }

      // --- chargement des donn√©es ---
      async function load() {
        try {
          const { data, error } = await db.from('calculateur')
            .select('id, category, infraction, classification, amende, garde_a_vue, audition, jour_fourriere, peine_compl')
            .order('category', { ascending: true })
            .limit(2000);
          if (error) throw error;
          infractions = data || [];
        } catch (err) {
          console.error('Erreur chargement calculateur:', err);
          el.list.innerHTML = `<div class="pill red">Erreur de chargement : ${err.message}</div>`;
          return;
        }
        renderList(infractions);
        renderSelection();
      }

      load();
    })();
  </script>
</body>
</html>
