<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administration — Saint-Georges Sheriff</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header>
  <div class="brand">
    <a href="index.html"><img src="badge.png" alt="badge"></a>
    <div class="title">SAINT-GEORGES SHERIFF — Administration</div>
  </div>
  <div class="spread">
    <span id="clock" class="pill">--:--:--</span>
    <span id="who" class="pill">Non connecté</span>
    <a href="index.html" class="btn ghost">← Accueil</a>
    <button id="btn-logout" class="btn gold hidden">Déconnexion</button>
  </div>
</header>

<main class="container">
  <!-- Accès restreint / Login inline -->
  <section class="card" id="admin-guard" style="display:none">
    <h3>Accès restreint</h3>
    <p class="muted">Cette page est réservée aux comptes avec le rôle <b>admin</b>.</p>
  </section>

  <section class="card" id="admin-login" style="display:none">
    <h3>Connexion requise</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px">
      <div>
        <label>Email</label>
        <input id="login-email" type="email" placeholder="ex: agent@exemple.com" />
      </div>
      <div>
        <label>Mot de passe</label>
        <input id="login-pass" type="password" placeholder="••••••••" />
      </div>
      <div class="center">
        <button id="btn-login-do" class="btn gold">Se connecter</button>
      </div>
    </div>
  </section>

  <!-- UTILISATEURS -->
  <section class="card" id="sec-users">
    <h3>Utilisateurs — création d’un compte</h3>
    <div class="tiles">
      <div class="equipe-tile">
        <h4>Créer un utilisateur</h4>
        <div class="row2">
          <input id="user-email" type="email" placeholder="Email" />
          <input id="user-pass" type="password" placeholder="Mot de passe" />
        </div>
        <div class="actions">
          <button id="btn-user-create" class="btn gold">Créer le compte</button>
        </div>
        <p class="muted" style="margin:6px 0 0">L’inscription par mot de passe doit être activée côté Auth.</p>
      </div>
    </div>
  </section>

  <!-- GRADES (tuiles) -->
  <section class="card" id="sec-grades">
    <div class="spread">
      <h3>Grades</h3>
      <div class="spread" style="gap:6px">
        <input id="grade-label" placeholder="Intitulé (ex: Sergent)" />
        <input id="grade-ordre" type="number" placeholder="Ordre (ex: 30)" />
        <button id="btn-grade-add" class="btn">Ajouter</button>
      </div>
    </div>
    <div id="tiles-grades" class="tiles-stack"></div>
  </section>

  <!-- EFFECTIFS (tuiles) -->
  <section class="card" id="sec-effectifs">
    <div class="spread">
      <h3>Effectifs</h3>
      <div class="spread" style="gap:6px">
        <input id="eff-nom" placeholder="Nom (ex: Doe John)" />
        <input id="eff-matricule" placeholder="Matricule (ex: SG-001)" />
        <input id="eff-grade" placeholder="Grade (texte)" />
        <button id="btn-eff-add" class="btn">Ajouter</button>
      </div>
    </div>
    <div id="tiles-effectifs" class="tiles-stack"></div>
  </section>

  <!-- INFRACTIONS (tuiles) -->
  <section class="card" id="sec-infractions">
    <div class="spread">
      <h3>Infractions</h3>
      <div class="grid" style="grid-template-columns: repeat(5, minmax(120px,1fr)); gap:8px">
        <input id="inf-cat"        placeholder="Catégorie" />
        <input id="inf-name"       placeholder="Infraction" />
        <input id="inf-classif"    placeholder="Classification (Contravention/Délit/Crime)" />
        <input id="inf-amende"     type="number" placeholder="Amende (ex: 500)" />
        <input id="inf-fourriere"  type="number" placeholder="Jour(s) fourrière (ex: 0)" />
      </div>
      <div class="spread" style="margin-top:8px">
        <textarea id="inf-peines" placeholder="Peines complémentaires (optionnel)"></textarea>
        <button class="btn" id="btn-inf-add">Ajouter</button>
      </div>
    </div>
    <div id="tiles-infractions" class="tiles-stack"></div>
  </section>

  <!-- VÉHICULES (tuiles) -->
  <section class="card" id="sec-vehicules">
    <div class="spread">
      <h3>Véhicules</h3>
      <div class="grid" style="grid-template-columns: repeat(4, minmax(160px,1fr)); gap:8px">
        <input id="veh-plaque" placeholder="Plaque" />
        <input id="veh-modele" placeholder="Modèle" />
        <input id="veh-couleur" placeholder="Couleur" />
        <input id="veh-statut"  placeholder="Statut (ex: service, garage…)" />
      </div>
      <div class="spread" style="margin-top:8px">
        <span class="muted">Renseigne au moins la plaque et le modèle.</span>
        <button class="btn" id="btn-veh-add">Ajouter</button>
      </div>
    </div>
    <div id="tiles-veh" class="tiles-stack"></div>
  </section>

  <!-- RESET COMPTEURS -->
  <section class="card" id="sec-reset">
    <div class="spread">
      <h3>Compteurs — Reset semaine</h3>
      <button class="btn gold" id="btn-reset-week">Reset semaine</button>
    </div>
    <p class="muted" style="margin-top:8px">
      Essaie d’abord la RPC <code>reset_compteurs_semaine()</code>.  
      Fallback : mise à 0 de <code>compteurs.semaine_minutes</code> si la table existe.
    </p>
    <div id="reset-result" class="muted"></div>
  </section>
</main>

<footer>© Sheriff’s Department — Saint-Georges</footer>

<script type="module">
  import { supabase, startClock, bindHeaderAuth, requireAuthOrRedirect } from "./common.js";

  // Noms de tables (adapte si besoin)
  const TBL_GRADES     = "grades";
  const TBL_EFFECTIFS  = "effectifs";
  const TBL_INFRACTIONS= "calculateur";
  const TBL_VEHICULES  = "vehicules";
  const TBL_COMPTEURS  = "compteurs";
  const TBL_PROFILES   = "profiles";

  startClock();
  bindHeaderAuth();

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const money = (n)=> `$${Number(n||0).toLocaleString()}`;

  // Guard + Login inline
  const guardBox = $("admin-guard");
  const loginBox = $("admin-login");
  const sections = ["sec-users","sec-grades","sec-effectifs","sec-infractions","sec-vehicules","sec-reset"].map($);

  $("btn-login-do").addEventListener("click", async ()=>{
    const email = $("login-email").value.trim();
    const password = $("login-pass").value.trim();
    if (!email || !password) return alert("Email et mot de passe requis.");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);
    location.reload();
  });

  async function ensureAdmin(){
    const { data: { user } } = await supabase.auth.getUser();
    if (!user){
      loginBox.style.display = "";
      guardBox.style.display = "none";
      sections.forEach(s=>s.style.display="none");
      return false;
    }
    // Check via RPC (robuste même si RLS bloque le SELECT)
    let ok = false;
    try {
      const { data, error } = await supabase.rpc("is_admin");
      if (error) throw error;
      ok = !!data;
    } catch (e) {
      console.warn("is_admin RPC error:", e.message);
    }
    if (!ok){
      loginBox.style.display = "none";
      guardBox.style.display = "";
      sections.forEach(s=>s.style.display="none");
      return false;
    }
    // Admin OK
    loginBox.style.display = "none";
    guardBox.style.display = "none";
    sections.forEach(s=>s.style.display="");
    return true;
  }

  // ====== UTILISATEURS
  $("btn-user-create").addEventListener("click", async ()=>{
    const email = $("user-email").value.trim();
    const pass  = $("user-pass").value.trim();
    if (!email || !pass) return alert("Email et mot de passe requis.");
    const { error } = await supabase.auth.signUp({ email, password: pass });
    if (error) return alert("Erreur création: " + error.message);
    alert("Compte créé (vérifie l’email si confirmation activée).");
    $("user-email").value = ""; $("user-pass").value = "";
  });

  // ====== RENDUS EN TUILES
  function makeTile(fields, actions){
    const wrap = document.createElement("div");
    wrap.className = "equipe-tile";
    let inner = "";
    for (const f of fields) {
      inner += `<div style="margin-bottom:6px">
        <label class="muted" style="font-size:12px">${f.label||""}</label>
        <input ${f.type==='number'?'type="number"':''} class="f" data-k="${f.key}" value="${f.value ?? ''}" placeholder="${f.placeholder||''}" />
      </div>`;
    }
    inner += `<div class="actions" style="margin-top:8px">${actions}</div>`;
    wrap.innerHTML = inner;
    return wrap;
  }

  // ====== GRADES
  async function loadGrades(){
    const box = $("tiles-grades");
    box.innerHTML = "";
    const { data, error } = await supabase.from(TBL_GRADES).select("*").order("ordre",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"ordre", label:"Ordre", value:row.ordre, type:"number", placeholder:"ex: 30"},
        {key:"label", label:"Intitulé", value:row.label, placeholder:"ex: Sergent"},
      ], `
        <button class="btn ghost act-save">Enregistrer</button>
        <button class="btn act-del">Supprimer</button>
      `);
      tile.querySelector(".act-save").onclick = async ()=>{
        const ordre = Number(tile.querySelector('[data-k="ordre"]').value||0);
        const label = tile.querySelector('[data-k="label"]').value.trim();
        const { error } = await supabase.from(TBL_GRADES).update({ ordre, label }).eq("id", row.id);
        if (error) alert(error.message); else loadGrades();
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer ce grade ?")) return;
        const { error } = await supabase.from(TBL_GRADES).delete().eq("id", row.id);
        if (error) alert(error.message); else loadGrades();
      };
      box.appendChild(tile);
    });
  }
  $("btn-grade-add").onclick = async ()=>{
    const label = $("grade-label").value.trim();
    const ordre = Number($("grade-ordre").value||0);
    if (!label) return alert("Intitulé requis.");
    const { error } = await supabase.from(TBL_GRADES).insert({ label, ordre });
    if (error) return alert(error.message);
    $("grade-label").value=""; $("grade-ordre").value="";
    loadGrades();
  };

  // ====== EFFECTIFS
  async function loadEffectifs(){
    const box = $("tiles-effectifs");
    box.innerHTML = "";
    const { data, error } = await supabase.from(TBL_EFFECTIFS).select("*").order("matricule",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"matricule", label:"Matricule", value:row.matricule, placeholder:"SG-001"},
        {key:"nom",       label:"Nom",       value:row.nom,       placeholder:"Doe John"},
        {key:"grade",     label:"Grade",     value:row.grade,     placeholder:"Sergent"},
      ], `
        <button class="btn ghost act-save">Enregistrer</button>
        <button class="btn act-del">Supprimer</button>
      `);
      tile.querySelector(".act-save").onclick = async ()=>{
        const matricule = tile.querySelector('[data-k="matricule"]').value.trim();
        const nom       = tile.querySelector('[data-k="nom"]').value.trim();
        const grade     = tile.querySelector('[data-k="grade"]').value.trim();
        const { error } = await supabase.from(TBL_EFFECTIFS).update({ matricule, nom, grade }).eq("id", row.id);
        if (error) alert(error.message); else loadEffectifs();
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer cet effectif ?")) return;
        const { error } = await supabase.from(TBL_EFFECTIFS).delete().eq("id", row.id);
        if (error) alert(error.message); else loadEffectifs();
      };
      box.appendChild(tile);
    });
  }
  $("btn-eff-add").onclick = async ()=>{
    const nom = $("eff-nom").value.trim();
    const matricule = $("eff-matricule").value.trim();
    const grade = $("eff-grade").value.trim();
    if (!nom || !matricule) return alert("Nom et Matricule requis.");
    const { error } = await supabase.from(TBL_EFFECTIFS).insert({ nom, matricule, grade });
    if (error) return alert(error.message);
    $("eff-nom").value=""; $("eff-matricule").value=""; $("eff-grade").value="";
    loadEffectifs();
  };

  // ====== INFRACTIONS
  async function loadInfractions(){
    const box = $("tiles-infractions");
    box.innerHTML = "";
    const { data, error } = await supabase.from(TBL_INFRACTIONS)
      .select("id, category, infraction, classification, amende, jour_fourriere, peine_compl")
      .order("category",{ascending:true})
      .order("infraction",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"category",        label:"Catégorie",        value:row.category,        placeholder:"Code de la route"},
        {key:"infraction",      label:"Infraction",       value:row.infraction,      placeholder:"Excès de vitesse"},
        {key:"classification",  label:"Classification",   value:row.classification,  placeholder:"Contravention/Délit/Crime"},
        {key:"amende",          label:"Amende",           value:row.amende,          type:"number", placeholder:"500"},
        {key:"jour_fourriere",  label:"Jours fourrière",  value:row.jour_fourriere,  type:"number", placeholder:"0"},
      ], `
        <button class="btn ghost act-save">Enregistrer</button>
        <button class="btn act-del">Supprimer</button>
      `);
      tile.querySelector(".act-save").onclick = async ()=>{
        const payload = {
          category:       tile.querySelector('[data-k="category"]').value.trim(),
          infraction:     tile.querySelector('[data-k="infraction"]').value.trim(),
          classification: tile.querySelector('[data-k="classification"]').value.trim(),
          amende:         Number(tile.querySelector('[data-k="amende"]').value||0),
          jour_fourriere: Number(tile.querySelector('[data-k="jour_fourriere"]').value||0),
        };
        const { error } = await supabase.from(TBL_INFRACTIONS).update(payload).eq("id", row.id);
        if (error) alert(error.message); else loadInfractions();
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer cette infraction ?")) return;
        const { error } = await supabase.from(TBL_INFRACTIONS).delete().eq("id", row.id);
        if (error) alert(error.message); else loadInfractions();
      };
      box.appendChild(tile);
    });
  }
  $("btn-inf-add").onclick = async ()=>{
    const payload = {
      category:       $("inf-cat").value.trim(),
      infraction:     $("inf-name").value.trim(),
      classification: $("inf-classif").value.trim(),
      amende:         Number($("inf-amende").value||0),
      jour_fourriere: Number($("inf-fourriere").value||0),
      peine_compl:    $("inf-peines").value.trim() || null,
    };
    if (!payload.category || !payload.infraction) return alert("Catégorie et libellé requis.");
    const { error } = await supabase.from(TBL_INFRACTIONS).insert(payload);
    if (error) return alert(error.message);
    ["inf-cat","inf-name","inf-classif","inf-amende","inf-fourriere","inf-peines"].forEach(id=>$(id).value="");
    loadInfractions();
  };

  // ====== VÉHICULES
  async function loadVehicules(){
    const box = $("tiles-veh");
    box.innerHTML = "";
    const { data, error } = await supabase.from(TBL_VEHICULES).select("*").order("plaque",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"plaque",  label:"Plaque",  value:row.plaque,  placeholder:"SG-123-XX"},
        {key:"modele",  label:"Modèle",  value:row.modele,  placeholder:"Interceptor"},
        {key:"couleur", label:"Couleur", value:row.couleur, placeholder:"Noir"},
        {key:"statut",  label:"Statut",  value:row.statut,  placeholder:"service/garage"},
      ], `
        <button class="btn ghost act-save">Enregistrer</button>
        <button class="btn act-del">Supprimer</button>
      `);
      tile.querySelector(".act-save").onclick = async ()=>{
        const payload = {
          plaque:  tile.querySelector('[data-k="plaque"]').value.trim(),
          modele:  tile.querySelector('[data-k="modele"]').value.trim(),
          couleur: tile.querySelector('[data-k="couleur"]').value.trim(),
          statut:  tile.querySelector('[data-k="statut"]').value.trim(),
        };
        const { error } = await supabase.from(TBL_VEHICULES).update(payload).eq("id", row.id);
        if (error) alert(error.message); else loadVehicules();
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer ce véhicule ?")) return;
        const { error } = await supabase.from(TBL_VEHICULES).delete().eq("id", row.id);
        if (error) alert(error.message); else loadVehicules();
      };
      box.appendChild(tile);
    });
  }
  $("btn-veh-add").onclick = async ()=>{
    const payload = {
      plaque:  $("veh-plaque").value.trim(),
      modele:  $("veh-modele").value.trim(),
      couleur: $("veh-couleur").value.trim(),
      statut:  $("veh-statut").value.trim()
    };
    if (!payload.plaque || !payload.modele) return alert("Plaque et Modèle requis.");
    const { error } = await supabase.from(TBL_VEHICULES).insert(payload);
    if (error) return alert(error.message);
    ["veh-plaque","veh-modele","veh-couleur","veh-statut"].forEach(id=>$(id).value="");
    loadVehicules();
  };

  // ====== RESET SEMAINE (robuste + message d’erreur détaillé)
  $("btn-reset-week").onclick = async ()=>{
    const out = $("reset-result");
    out.textContent = "Traitement en cours…";
    try {
      // RPC prioritaire
      const rpc = await supabase.rpc("reset_compteurs_semaine");
      if (rpc.error) throw rpc.error;
      out.textContent = "Reset effectué via RPC reset_compteurs_semaine().";
      return;
    } catch (e) {
      console.warn("RPC reset_compteurs_semaine error:", e.message);
    }
    try {
      // Fallback sur table/colonne
      const { error } = await supabase.from(TBL_COMPTEURS).update({ semaine_minutes: 0 });
      if (error) throw error;
      $("reset-result").textContent = "Reset effectué sur la table 'compteurs' (semaine_minutes=0).";
    } catch (e) {
      $("reset-result").textContent = "Échec du reset (ni RPC ni fallback). Vérifie la DB.";
      console.error(e);
    }
  };

  // ====== BOOT
  if (await ensureAdmin()) {
    await Promise.all([loadGrades(), loadEffectifs(), loadInfractions(), loadVehicules()]);
  }
</script>
</body>
</html>
