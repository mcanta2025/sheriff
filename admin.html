<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administration — Saint-Georges Sheriff</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Accordéon minimal, compatible avec ton thème */
    details.card { padding:0 }
    details.card > summary {
      list-style:none; cursor:pointer; user-select:none;
      padding:16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:radial-gradient(1200px 600px at 10% -10%, #1a1b1e 0%, var(--panel) 35%, var(--panel-2) 100%);
      border-radius:16px 16px 0 0;
    }
    details.card > .content { padding:16px }
    .chev { opacity:.7; transition:transform .15s ease }
    details[open] .chev { transform:rotate(90deg) }
    .tiles-stack { max-height:calc(100vh - 240px); overflow:auto; padding-right:6px }
    .equipe-tile input, .equipe-tile textarea { width:100% }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:6px }
    .actions { display:flex; justify-content:flex-end; gap:6px; margin-top:6px }
    .muted.small { font-size:12px }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <a href="index.html"><img src="badge.png" alt="badge"></a>
    <div class="title">SAINT-GEORGES SHERIFF — Administration</div>
  </div>
  <div class="spread">
    <span id="clock" class="pill">--:--:--</span>
    <span id="who" class="pill">Non connecté</span>
    <a href="index.html" class="btn ghost">← Accueil</a>
    <button id="btn-logout" class="btn gold hidden">Déconnexion</button>
  </div>
</header>

<main class="container">
  <!-- Accès / login -->
  <section class="card" id="admin-guard" style="display:none">
    <h3>Accès restreint</h3>
    <p class="muted">Cette page est réservée aux comptes avec le rôle <b>admin</b>.</p>
  </section>

  <section class="card" id="admin-login" style="display:none">
    <h3>Connexion requise</h3>
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px">
      <div>
        <label>Email</label>
        <input id="login-email" type="email" placeholder="ex: agent@exemple.com" />
      </div>
      <div>
        <label>Mot de passe</label>
        <input id="login-pass" type="password" placeholder="••••••••" />
      </div>
      <div class="center">
        <button id="btn-login-do" class="btn gold">Se connecter</button>
      </div>
    </div>
  </section>

  <!-- UTILISATEURS -->
  <details class="card" id="sec-users" open>
    <summary>
      <h3 style="margin:0">Utilisateurs</h3>
      <span class="muted">Créer un compte</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="tiles">
        <div class="equipe-tile">
          <h4>Créer un utilisateur</h4>
          <div class="row2">
            <input id="user-email" type="email" placeholder="Email" />
            <input id="user-pass" type="password" placeholder="Mot de passe" />
          </div>
          <div class="actions">
            <button id="btn-user-create" class="btn gold">Créer le compte</button>
          </div>
          <p class="muted small">L’inscription par mot de passe doit être activée côté Auth.</p>
        </div>
      </div>
    </div>
  </details>

  <!-- GRADES -->
  <details class="card" id="sec-grades">
    <summary>
      <h3 style="margin:0">Grades</h3>
      <span class="muted">Ajouter / modifier</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="spread" style="gap:6px; margin-bottom:10px">
        <input id="grade-label" placeholder="Intitulé (ex: Sergent)" />
        <input id="grade-ordre" type="number" placeholder="Ordre (ex: 30)" />
        <button id="btn-grade-add" class="btn">Ajouter</button>
      </div>
      <div id="tiles-grades" class="tiles-stack"></div>
    </div>
  </details>

  <!-- EFFECTIFS -->
  <details class="card" id="sec-effectifs">
    <summary>
      <h3 style="margin:0">Effectifs</h3>
      <span class="muted">Ajouter / modifier</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="spread" style="gap:6px; margin-bottom:10px; flex-wrap:wrap">
        <input id="eff-nom" placeholder="Nom (ex: Doe John)" />
        <input id="eff-matricule" placeholder="Matricule (ex: SG-001)" />
        <input id="eff-grade" placeholder="Grade (texte)" />
        <button id="btn-eff-add" class="btn">Ajouter</button>
      </div>
      <div id="tiles-effectifs" class="tiles-stack"></div>
    </div>
  </details>

  <!-- INFRACTIONS -->
  <details class="card" id="sec-infractions">
    <summary>
      <h3 style="margin:0">Infractions</h3>
      <span class="muted">Ajouter / modifier</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="grid" style="grid-template-columns: repeat(5, minmax(120px,1fr)); gap:8px">
        <input id="inf-cat"        placeholder="Catégorie" />
        <input id="inf-name"       placeholder="Infraction" />
        <input id="inf-classif"    placeholder="Classification (Contravention/Délit/Crime)" />
        <input id="inf-amende"     type="number" placeholder="Amende (ex: 500)" />
        <input id="inf-fourriere"  type="number" placeholder="Jour(s) fourrière (ex: 0)" />
      </div>
      <div class="spread" style="margin-top:8px">
        <textarea id="inf-peines" placeholder="Peines complémentaires (optionnel)"></textarea>
        <button class="btn" id="btn-inf-add">Ajouter</button>
      </div>
      <div id="tiles-infractions" class="tiles-stack" style="margin-top:10px"></div>
    </div>
  </details>

  <!-- VÉHICULES -->
  <details class="card" id="sec-vehicules">
    <summary>
      <h3 style="margin:0">Véhicules</h3>
      <span class="muted">Ajouter / modifier</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="grid" style="grid-template-columns: repeat(4, minmax(160px,1fr)); gap:8px">
        <input id="veh-plaque" placeholder="Plaque" />
        <input id="veh-modele" placeholder="Modèle" />
        <input id="veh-couleur" placeholder="Couleur" />
        <input id="veh-statut"  placeholder="Statut (ex: service, garage…)" />
      </div>
      <div class="spread" style="margin-top:8px">
        <span class="muted">Renseigne au moins la plaque et le modèle.</span>
        <button class="btn" id="btn-veh-add">Ajouter</button>
      </div>
      <div id="tiles-veh" class="tiles-stack" style="margin-top:10px"></div>
    </div>
  </details>

  <!-- RESET COMPTEURS -->
  <details class="card" id="sec-reset">
    <summary>
      <h3 style="margin:0">Compteurs</h3>
      <span class="muted">Reset semaine</span>
      <span class="chev">▶</span>
    </summary>
    <div class="content">
      <div class="spread">
        <button class="btn gold" id="btn-reset-week">Reset semaine</button>
      </div>
      <p class="muted small" style="margin-top:8px">
        La RPC <code>reset_compteurs_semaine()</code> est tentée en premier.  
        Sinon, le script essaie plusieurs combinaisons table/colonne.  
        <b>Idéal :</b> définis ci-dessous la table/colonne exactes pour le reset.
      </p>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">
        <input id="reset-table" placeholder="Nom table ex: compteurs (optionnel)" />
        <input id="reset-col"   placeholder="Nom colonne ex: semaine_minutes (optionnel)" />
      </div>
      <div id="reset-result" class="muted" style="margin-top:6px"></div>
    </div>
  </details>
</main>

<footer>© Sheriff’s Department — Saint-Georges</footer>

<script type="module">
  import { supabase, startClock, bindHeaderAuth } from "./common.js";

  /* =================== CONFIG (adapte au besoin) =================== */
  const CONFIG = {
    tables: {
      grades:      "grades",
      effectifs:   "effectifs",
      infractions: "calculateur",
      vehicules:   "vehicules",
      profiles:    "profiles"
    },
    keys: {
      // Clés candidates pour identifier un effectif
      effectifsPKCandidates: ["id","id_effectif","effectif_id","eid","uid","matricule","mat"],
      // Mapping possible pour véhicules (détection par ligne)
      vehicules: {
        id:      ["id","ID","vehicule_id","vehicle_id"],
        plaque:  ["plaque","immatriculation","plate","registration","immat","reg"],
        modele:  ["modele","model","modèle"],
        couleur: ["couleur","color","colour"],
        statut:  ["statut","status","state"]
      }
    },
    reset: {
      rpc: "reset_compteurs_semaine",
      // Si tu connais les vrais noms, fixe-les ici, sinon laisse null pour autodétection
      table: null, // ex: "compteurs"
      col:   null, // ex: "semaine_minutes"
      // valeurs essayées si pas d'override
      tableCandidates: ["compteurs","compteur"],
      colCandidates:   ["semaine_minutes","semaine","minutes_semaine"]
    }
  };

  /* =================== Header / Auth =================== */
  startClock();
  bindHeaderAuth();

  // Accordéon: ne garder ouvert qu'un seul bloc à la fois
  document.querySelectorAll("details.card > summary").forEach(sum=>{
    sum.addEventListener("click", (e)=>{
      const d = sum.parentElement;
      if (!d.open) {
        document.querySelectorAll("details.card[open]").forEach(o=>{ if(o!==d) o.removeAttribute("open"); });
      }
    });
  });

  // Petit flash message
  function flash(msg, type="info"){
    const clr = type==="error" ? "badge badge-red" : type==="ok" ? "badge badge-green" : "badge";
    const x = document.createElement("div");
    x.innerHTML = `<span class="${clr}" style="display:inline-block; margin:8px 0">${msg}</span>`;
    document.body.appendChild(x);
    setTimeout(()=>x.remove(), 3500);
  }

  // Helper DOM
  const $ = (id)=>document.getElementById(id);

  /* =================== Guard Admin =================== */
  async function ensureAdmin(){
    const { data: { user } } = await supabase.auth.getUser();
    const guard = $("admin-guard"), login = $("admin-login");
    const sections = Array.from(document.querySelectorAll("details.card"));

    if (!user){
      login.style.display = ""; guard.style.display = "none";
      sections.forEach(s=>s.style.display="none");
      $("btn-login-do").onclick = async ()=>{
        const email = $("login-email").value.trim();
        const password = $("login-pass").value.trim();
        if (!email || !password) return alert("Email et mot de passe requis.");
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return alert(error.message);
        location.reload();
      };
      return false;
    }
    // Check via RPC is_admin si dispo, sinon fallback via profiles.role
    let ok = false;
    try { const { data } = await supabase.rpc("is_admin"); ok = !!data; } catch {}
    if (!ok){
      try{
        const { data } = await supabase.from(CONFIG.tables.profiles).select("role").eq("id", user.id).maybeSingle();
        ok = (data?.role || "").toLowerCase() === "admin";
      }catch{}
    }
    if (!ok){
      login.style.display = "none"; guard.style.display = "";
      sections.forEach(s=>s.style.display="none");
      return false;
    }
    login.style.display = "none"; guard.style.display = "none";
    sections.forEach(s=>s.style.display="");
    return true;
  }

  /* =================== Utils =================== */
  const money = (n)=> `$${Number(n||0).toLocaleString()}`;
  function makeTile(fields, actionsHTML){
    const wrap = document.createElement("div");
    wrap.className = "equipe-tile";
    let inner = "";
    fields.forEach(f=>{
      inner += `<div style="margin-bottom:6px">
        <label class="muted small">${f.label||""}</label>
        <input ${f.type==='number'?'type="number"':''} class="f" data-k="${f.key}" value="${f.value ?? ''}" placeholder="${f.placeholder||''}" />
      </div>`;
    });
    inner += `<div class="actions">${actionsHTML}</div>`;
    wrap.innerHTML = inner;
    return wrap;
  }
  function resolveKey(row, candidates){
    for (const k of candidates){
      if (row && Object.prototype.hasOwnProperty.call(row, k) && row[k] != null) return { col:k, val:row[k] };
    }
    return { col:null, val:null };
  }
  function keyMapFromRow(row, dict){
    const lower = Object.fromEntries(Object.keys(row||{}).map(k=>[k.toLowerCase(), k]));
    const pick = (list)=> list.map(x=>x.toLowerCase()).map(x=>lower[x]).find(Boolean);
    return {
      id:      pick(dict.id || []),
      plaque:  pick(dict.plaque || []),
      modele:  pick(dict.modele || []),
      couleur: pick(dict.couleur|| []),
      statut:  pick(dict.statut || []),
    };
  }

  /* =================== GRADES =================== */
  async function loadGrades(){
    const box = $("tiles-grades"); box.innerHTML = "";
    const { data, error } = await supabase.from(CONFIG.tables.grades).select("*").order("ordre",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"ordre", label:"Ordre", value:row.ordre, type:"number", placeholder:"ex: 30"},
        {key:"label", label:"Intitulé", value:row.label, placeholder:"ex: Sergent"},
      ], `<button class="btn ghost act-save">Enregistrer</button><button class="btn act-del">Supprimer</button>`);
      const idcol = resolveKey(row, ["id","grade_id","ID"]).col;
      tile.querySelector(".act-save").onclick = async ()=>{
        const ordre = Number(tile.querySelector('[data-k="ordre"]').value||0);
        const label = tile.querySelector('[data-k="label"]').value.trim();
        const q = supabase.from(CONFIG.tables.grades).update({ ordre, label }).eq(idcol, row[idcol]).select();
        const { data:ret, error } = await q;
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne modifiée (RLS ?).");
        loadGrades(); flash("Grade enregistré","ok");
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer ce grade ?")) return;
        const { data:ret, error } = await supabase.from(CONFIG.tables.grades).delete().eq(idcol, row[idcol]).select();
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne supprimée (RLS ?).");
        loadGrades(); flash("Grade supprimé","ok");
      };
      box.appendChild(tile);
    });
  }
  $("btn-grade-add").onclick = async ()=>{
    const label = $("grade-label").value.trim();
    const ordre = Number($("grade-ordre").value||0);
    if (!label) return alert("Intitulé requis.");
    const { data, error } = await supabase.from(CONFIG.tables.grades).insert({ label, ordre }).select();
    if (error) return alert(error.message);
    if (!data?.length) return alert("Insertion non autorisée (RLS ?).");
    $("grade-label").value=""; $("grade-ordre").value="";
    loadGrades(); flash("Grade ajouté","ok");
  };

  /* =================== EFFECTIFS =================== */
  async function loadEffectifs(){
    const box = $("tiles-effectifs"); box.innerHTML = "";
    const { data, error } = await supabase.from(CONFIG.tables.effectifs).select("*").order("matricule",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"matricule", label:"Matricule", value:row.matricule ?? row.MATRICULE ?? "", placeholder:"SG-001"},
        {key:"nom",       label:"Nom",       value:row.nom ?? row.NOM ?? "",           placeholder:"Doe John"},
        {key:"grade",     label:"Grade",     value:row.grade ?? row.GRADE ?? "",       placeholder:"Sergent"},
      ], `<button class="btn ghost act-save">Enregistrer</button><button class="btn act-del">Supprimer</button>`);
      const { col:pk, val } = resolveKey(row, CONFIG.keys.effectifsPKCandidates);

      tile.querySelector(".act-save").onclick = async ()=>{
        const payload = {
          matricule: tile.querySelector('[data-k="matricule"]').value.trim(),
          nom:       tile.querySelector('[data-k="nom"]').value.trim(),
          grade:     tile.querySelector('[data-k="grade"]').value.trim()
        };
        let res;
        if (pk) res = await supabase.from(CONFIG.tables.effectifs).update(payload).eq(pk, val).select();
        else if (row.matricule) res = await supabase.from(CONFIG.tables.effectifs).update(payload).eq("matricule", row.matricule).select();
        else return alert("Impossible d’identifier la ligne (clé).");

        if (res.error) return alert(res.error.message);
        if (!res.data?.length) return alert("Aucune ligne modifiée (RLS ?).");
        loadEffectifs(); flash("Effectif enregistré","ok");
      };

      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer cet effectif ?")) return;
        let res;
        if (pk) res = await supabase.from(CONFIG.tables.effectifs).delete().eq(pk, val).select();
        else if (row.matricule) res = await supabase.from(CONFIG.tables.effectifs).delete().eq("matricule", row.matricule).select();
        else return alert("Impossible d’identifier la ligne (clé).");

        if (res.error) return alert(res.error.message);
        if (!res.data?.length) return alert("Aucune ligne supprimée (RLS ?).");
        loadEffectifs(); flash("Effectif supprimé","ok");
      };

      box.appendChild(tile);
    });
  }
  $("btn-eff-add").onclick = async ()=>{
    const nom = $("eff-nom").value.trim();
    const matricule = $("eff-matricule").value.trim();
    const grade = $("eff-grade").value.trim();
    if (!nom || !matricule) return alert("Nom et Matricule requis.");
    const { data, error } = await supabase.from(CONFIG.tables.effectifs).insert({ nom, matricule, grade }).select();
    if (error) return alert(error.message);
    if (!data?.length) return alert("Insertion non autorisée (RLS ?).");
    $("eff-nom").value=""; $("eff-matricule").value=""; $("eff-grade").value="";
    loadEffectifs(); flash("Effectif ajouté","ok");
  };

  /* =================== INFRACTIONS =================== */
  async function loadInfractions(){
    const box = $("tiles-infractions"); box.innerHTML = "";
    const { data, error } = await supabase.from(CONFIG.tables.infractions)
      .select("id, category, infraction, classification, amende, jour_fourriere, peine_compl")
      .order("category",{ascending:true}).order("infraction",{ascending:true});
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    (data||[]).forEach(row=>{
      const tile = makeTile([
        {key:"category",        label:"Catégorie",        value:row.category,        placeholder:"Code de la route"},
        {key:"infraction",      label:"Infraction",       value:row.infraction,      placeholder:"Excès de vitesse"},
        {key:"classification",  label:"Classification",   value:row.classification,  placeholder:"Contravention/Délit/Crime"},
        {key:"amende",          label:"Amende",           value:row.amende,          type:"number", placeholder:"500"},
        {key:"jour_fourriere",  label:"Jours fourrière",  value:row.jour_fourriere,  type:"number", placeholder:"0"},
      ], `<button class="btn ghost act-save">Enregistrer</button><button class="btn act-del">Supprimer</button>`);
      const idcol = resolveKey(row, ["id","ID"]).col;

      tile.querySelector(".act-save").onclick = async ()=>{
        const payload = {
          category:       tile.querySelector('[data-k="category"]').value.trim(),
          infraction:     tile.querySelector('[data-k="infraction"]').value.trim(),
          classification: tile.querySelector('[data-k="classification"]').value.trim(),
          amende:         Number(tile.querySelector('[data-k="amende"]').value||0),
          jour_fourriere: Number(tile.querySelector('[data-k="jour_fourriere"]').value||0),
        };
        if (!idcol) return alert("Ligne sans identifiant (colonne id manquante).");
        const { data:ret, error } = await supabase.from(CONFIG.tables.infractions).update(payload).eq(idcol, row[idcol]).select();
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne modifiée (RLS ?).");
        loadInfractions(); flash("Infraction enregistrée","ok");
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer cette infraction ?")) return;
        if (!idcol) return alert("Ligne sans identifiant (colonne id manquante).");
        const { data:ret, error } = await supabase.from(CONFIG.tables.infractions).delete().eq(idcol, row[idcol]).select();
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne supprimée (RLS ?).");
        loadInfractions(); flash("Infraction supprimée","ok");
      };
      box.appendChild(tile);
    });
  }
  $("btn-inf-add").onclick = async ()=>{
    const payload = {
      category:       $("inf-cat").value.trim(),
      infraction:     $("inf-name").value.trim(),
      classification: $("inf-classif").value.trim(),
      amende:         Number($("inf-amende").value||0),
      jour_fourriere: Number($("inf-fourriere").value||0),
      peine_compl:    $("inf-peines").value.trim() || null,
    };
    if (!payload.category || !payload.infraction) return alert("Catégorie et libellé requis.");
    const { data, error } = await supabase.from(CONFIG.tables.infractions).insert(payload).select();
    if (error) return alert(error.message);
    if (!data?.length) return alert("Insertion non autorisée (RLS ?).");
    ["inf-cat","inf-name","inf-classif","inf-amende","inf-fourriere","inf-peines"].forEach(id=>$(id).value="");
    loadInfractions(); flash("Infraction ajoutée","ok");
  };

  /* =================== VÉHICULES =================== */
  async function loadVehicules(){
    const box = $("tiles-veh"); box.innerHTML = "";
    const { data, error } = await supabase.from(CONFIG.tables.vehicules).select("*");
    if (error){ box.innerHTML = `<div class="muted">Erreur: ${error.message}</div>`; return; }
    const rows = data||[];
    const map = rows.length ? keyMapFromRow(rows[0], CONFIG.keys.vehicules) : { id:"id", plaque:"plaque", modele:"modele", couleur:"couleur", statut:"statut" };

    rows.forEach(row=>{
      const tile = makeTile([
        {key:"plaque",  label:"Plaque",  value: row[map.plaque]  ?? "", placeholder:"SG-123-XX"},
        {key:"modele",  label:"Modèle",  value: row[map.modele]  ?? "", placeholder:"Interceptor"},
        {key:"couleur", label:"Couleur", value: row[map.couleur] ?? "", placeholder:"Noir"},
        {key:"statut",  label:"Statut",  value: row[map.statut]  ?? "", placeholder:"service/garage"},
      ], `<button class="btn ghost act-save">Enregistrer</button><button class="btn act-del">Supprimer</button>`);

      const idcol = map.id; // on exige une clé id-like pour update/delete fiables
      tile.querySelector(".act-save").onclick = async ()=>{
        const payload = {
          [map.plaque || "plaque"]:  tile.querySelector('[data-k="plaque"]').value.trim(),
          [map.modele || "modele"]:  tile.querySelector('[data-k="modele"]').value.trim(),
          [map.couleur|| "couleur"]: tile.querySelector('[data-k="couleur"]').value.trim(),
          [map.statut || "statut"]:  tile.querySelector('[data-k="statut"]').value.trim(),
        };
        if (!idcol) return alert("Pas de colonne identifiant (id) sur la table véhicules.");
        const { data:ret, error } = await supabase.from(CONFIG.tables.vehicules).update(payload).eq(idcol, row[idcol]).select();
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne modifiée (RLS ?).");
        loadVehicules(); flash("Véhicule enregistré","ok");
      };
      tile.querySelector(".act-del").onclick = async ()=>{
        if (!confirm("Supprimer ce véhicule ?")) return;
        if (!idcol) return alert("Pas de colonne identifiant (id) sur la table véhicules.");
        const { data:ret, error } = await supabase.from(CONFIG.tables.vehicules).delete().eq(idcol, row[idcol]).select();
        if (error) return alert(error.message);
        if (!ret?.length) return alert("Aucune ligne supprimée (RLS ?).");
        loadVehicules(); flash("Véhicule supprimé","ok");
      };

      box.appendChild(tile);
    });
  }
  $("btn-veh-add").onclick = async ()=>{
    // Insertion avec champs "standards". Si tes colonnes diffèrent, adapte ici.
    const payload = {
      plaque:  $("veh-plaque").value.trim(),
      modele:  $("veh-modele").value.trim(),
      couleur: $("veh-couleur").value.trim(),
      statut:  $("veh-statut").value.trim()
    };
    if (!payload.plaque || !payload.modele) return alert("Plaque et Modèle requis.");
    const { data, error } = await supabase.from(CONFIG.tables.vehicules).insert(payload).select();
    if (error) return alert(error.message);
    if (!data?.length) return alert("Insertion non autorisée (RLS ?).");
    ["veh-plaque","veh-modele","veh-couleur","veh-statut"].forEach(id=>$(id).value="");
    loadVehicules(); flash("Véhicule ajouté","ok");
  };

  /* =================== RESET semaine =================== */
  async function doReset(table, col){
    const { error } = await supabase.from(table).update({ [col]: 0 }).select();
    if (error) throw error;
    return `${table}.${col} = 0`;
  }
  async function resetSemaine(){
    const out = $("reset-result");
    const overrideTable = $("reset-table").value.trim() || CONFIG.reset.table;
    const overrideCol   = $("reset-col").value.trim()   || CONFIG.reset.col;
    out.textContent = "Traitement en cours…";

    // 1) RPC prioritaire
    try{
      const { error } = await supabase.rpc(CONFIG.reset.rpc);
      if (error) throw error;
      out.textContent = "Reset effectué via RPC reset_compteurs_semaine().";
      flash("Reset semaine effectué","ok");
      return;
    }catch(e){ out.textContent = `RPC indisponible: ${e.message}. Tentative fallback…`; }

    // 2) Overrides si fournis
    if (overrideTable && overrideCol){
      try{
        const msg = await doReset(overrideTable, overrideCol);
        out.textContent = `Reset effectué sur ${msg}`;
        flash("Reset semaine effectué","ok");
        return;
      }catch(e){ out.textContent = `Échec override ${overrideTable}.${overrideCol} → ${e.message}`; }
    }

    // 3) Probes
    for (const t of CONFIG.reset.tableCandidates){
      for (const c of CONFIG.reset.colCandidates){
        try{
          const msg = await doReset(t, c);
          out.textContent = `Reset effectué sur ${msg}`;
          flash("Reset semaine effectué","ok");
          return;
        }catch(e){ /* on continue */ }
      }
    }
    out.textContent = "Échec du reset (ni RPC ni fallback). Vérifie le nom de la table et de la colonne, ou renseigne-les ci-dessus.";
    flash("Reset semaine échoué","error");
  }
  $("btn-reset-week").onclick = resetSemaine;

  /* =================== BOOT =================== */
  if (await ensureAdmin()){
    await Promise.all([loadGrades(), loadEffectifs(), loadInfractions(), loadVehicules()]);
  }
</script>
</body>
</html>
